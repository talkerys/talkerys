generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum PaymentMethod {
  YAPE
  PLIN
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RegistrationStatus {
  PENDING_ASSIGNMENT
  CONFIRMED
  CANCELLED
}

enum MaterialScope {
  GENERAL
  EVENT
  TABLE
  USER
}

model User {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  email        String   @unique
  passwordHash String
  fullName     String
  phone        String?
  role         Role     @default(USER)

  profile      Profile?
  credits      CreditBalance?
  payments     Payment[]
  registrations Registration[]
  materials    Material[] @relation("UserMaterials")

  @@index([role])
}

model Profile {
  id          String   @id @default(cuid())
  userId      String   @unique
  level       String   // A1..C2 o texto
  goals       String   // texto corto
  interests   String   // CSV simple para MVP
  pace        String   // "tranquila" / "intensa"
  shareWithTable Boolean @default(true)

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CreditBalance {
  id        String   @id @default(cuid())
  userId    String   @unique
  credits   Int      @default(0)
  expiresAt DateTime?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Cafe {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  name      String
  address   String
  googleMapsUrl String?
  notes     String?

  events    Event[]
}

model Event {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  startsAt    DateTime
  endsAt      DateTime
  topic       String
  levelHint   String?
  capacity    Int      @default(24)

  cafeId      String
  cafe        Cafe     @relation(fields: [cafeId], references: [id], onDelete: Restrict)

  tables      Table[]
  registrations Registration[]
  materials   Material[]
}

model Table {
  id        String @id @default(cuid())
  eventId   String
  number    Int
  capacity  Int    @default(8)

  event     Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  registrations Registration[]
  materials Material[]

  @@unique([eventId, number])
}

model Registration {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  eventId   String
  tableId   String?
  status    RegistrationStatus @default(PENDING_ASSIGNMENT)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  table     Table?   @relation(fields: [tableId], references: [id], onDelete: SetNull)

  @@unique([userId, eventId])
  @@index([eventId, status])
  @@index([tableId])
}

model Payment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  method    PaymentMethod
  amount    Int
  plan      String   // "1", "2", "4"
  receiptUrl String?
  status    PaymentStatus @default(PENDING)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

model Material {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  title     String
  fileUrl   String
  scope     MaterialScope @default(GENERAL)

  eventId   String?
  tableId   String?
  userId    String?

  event     Event?   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  table     Table?   @relation(fields: [tableId], references: [id], onDelete: Cascade)
  user      User?    @relation("UserMaterials", fields: [userId], references: [id], onDelete: Cascade)

  @@index([scope])
}
